#!/usr/bin/env bash
# DevLink pre-commit hook â€” managed by kb-labs-devkit, do not edit manually.
# Switches cross-repo deps to npm mode on first commit in a session.
# Subsequent commits skip (already in npm mode).

REPO_DIR="$(git rev-parse --show-toplevel)"

# Walk up from repo to find the kb-labs monorepo root (has kb-labs-cli/packages/cli-bin)
KB_ROOT="$REPO_DIR"
while [ "$KB_ROOT" != "/" ]; do
  if [ -f "$KB_ROOT/kb-labs-cli/packages/cli-bin/dist/bin.js" ]; then
    break
  fi
  KB_ROOT="$(dirname "$KB_ROOT")"
done

if [ "$KB_ROOT" = "/" ]; then
  # Fallback: try parent of repo
  KB_ROOT="$(dirname "$REPO_DIR")"
fi

# Check if devlink is available
if ! pnpm --prefix "$KB_ROOT" kb devlink --help > /dev/null 2>&1; then
  exit 0
fi

# Clear plugin cache before check (stale cache can cause false "unknown command")
pnpm --prefix "$KB_ROOT" kb plugins clear-cache > /dev/null 2>&1 || true

# Skip if already in npm mode
STATUS=$(pnpm --prefix "$KB_ROOT" kb devlink status --json 2>/dev/null | grep '"currentMode"' | grep -o '"npm"\|"local"\|null')
if [ "$STATUS" = '"npm"' ]; then
  exit 0
fi

echo "[devlink] switching to npm mode..."
pnpm --prefix "$KB_ROOT" kb devlink switch --mode=npm
